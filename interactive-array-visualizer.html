<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Array Interactive Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        #array-container {
            width: 100%;
            max-width: 100%;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            overflow: auto;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            max-width: 830px;
            width: 100%;
        }

        .control-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .divisor {
            height: 2px;
            background-color: #333;
            width: 100%;
            margin: 5px 0;
        }

        .section-title {
            width: 100%;
            font-weight: bold;
            margin-bottom: 5px;
            color: #b0b0b0;
        }

        button, input {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: filter 0.3s ease;
        }

        button:hover {
            filter: brightness(85%);
        }

        input[type="text"] {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border: 1px solid #5a5a5a;
            width: 195px;
        }

        input[type="number"] {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border: 1px solid #5a5a5a;
            width: 30px;
        }

        input[type="color"] {
            width: 50px;
            height: 30px;
            padding: 0;
            border: none;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
            max-width: 200px;
        }

        .color-picker label {
            min-width: 70px;
            text-align: right;
            margin-right: 5px;
        }

        .text-settings {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }

        .text-settings label {
            text-align: right;
        }

        .text-settings input[type="number"],
        .text-settings input[type="color"] {
            width: 60px;
        }

        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .checkbox-control input[type="checkbox"] {
            margin: 0;
        }

        .checkbox-control label {
            margin-left: 5px;
        }

        #array-list {
            width: 100%;
        }

        .array-name {
            font-family: monospace;
            font-size: 14px;
        }

        .array-name-input {
            width: 150px;
            margin-right: 10px;
        }

        .array-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #3a3a3a;
            border-radius: 4px;
        }

        .array-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .array-item button {
            margin-left: 10px;
        }

        .array-edit {
            display: flex;
            align-items: center;
        }

        .array-edit input {
            flex-grow: 1;
        }

        #element-menu {
            display: none;
            position: absolute;
            background-color: #444;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 10px;
            width: 160px;
        }

        #element-menu input,
        #element-menu button {
            width: 100%;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        #element-menu input {
            padding: 5px;
        }

        .highlight-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .highlight-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .highlight-button {
            flex: 1;
            margin: 0 2px;
            padding: 5px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: filter 0.3s ease;
        }

        .highlight-button:hover {
            filter: brightness(85%);
        }

        #remove-button-color {
            background-color: #d9534f;
            color: white;
            transition: background-color 0.3s ease;
        }

        #remove-button-color:hover {
            background-color: #c9302c; /* Darker shade for hover */
        }
    </style>
</head>
<body>
<div id="array-container">
    <svg></svg>
</div>
<div class="controls">
    <div class="control-section">
        <div class="section-title">Array Input</div>
        <label for="array-input"></label><input type="text" id="array-input"
                                                placeholder="Enter array (comma-separated)">
        <button onclick="addArray()">Add Array</button>
        <div class="divisor"></div>
        <div class="section-title">Array List</div>
        <div id="array-list"></div>
        <div style="display: none;">
            <div class="array-item"></div>
            <div class="array-name"></div>
        </div>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">Display Options</div>
        <div class="checkbox-control">
            <input type="checkbox" id="show-indexes" checked onchange="drawArrays()">
            <label for="show-indexes">Show Indexes</label>
        </div>
        <div class="checkbox-control">
            <input type="checkbox" id="show-names" checked onchange="drawArrays()">
            <label for="show-names">Show Array Names</label>
        </div>
        <div class="checkbox-control">
            <input type="checkbox" id="show-arrows" onchange="drawArrays()">
            <label for="show-arrows">Show Arrows</label>
        </div>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">Color Settings</div>
        <div class="color-picker">
            <label for="base-color">Base:</label>
            <input type="color" id="base-color" value="#E3F9F9" onchange="updateColors()">
        </div>
        <div class="color-picker">
            <label for="highlight1-color">Highlight 1:</label>
            <input type="color" id="highlight1-color" value="#1AD1B2" onchange="updateColors()">
        </div>
        <div class="color-picker">
            <label for="highlight2-color">Highlight 2:</label>
            <input type="color" id="highlight2-color" value="#1AD1B2" onchange="updateColors()">
        </div>
        <div class="color-picker">
            <label for="highlight3-color">Highlight 3:</label>
            <input type="color" id="highlight3-color" value="#91C0BF" onchange="updateColors()">
        </div>
        <div class="color-picker">
            <label for="element-font-color">Element:</label>
            <input type="color" id="element-font-color" value="#1a1a1a" onchange="updateFontColors()">
        </div>
        <div class="color-picker">
            <label for="index-font-color">Index and Name:</label>
            <input type="color" id="index-font-color" value="#e0e0e0" onchange="updateFontColors()">
        </div>
        <div class="color-picker">
            <label for="arrow-color">Arrow:</label>
            <input type="color" id="arrow-color" value="#FFFFFF" onchange="updateColors()">
        </div>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">Text Settings</div>
        <div class="text-settings">
            <label for="element-font-size">Element Size:</label>
            <input type="number" id="element-font-size" value="30" min="20" max="50" onchange="changeFontSize()">

            <label for="index-font-size">Index Size:</label>
            <input type="number" id="index-font-size" value="17" min="10" max="20" onchange="changeFontSize()">
        </div>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">Reset Settings</div>
        <button onclick="resetArraySettings()">Reset Array Settings</button>
        <button onclick="resetFontSettings()">Reset Font Settings</button>
        <button onclick="resetArrowSettings()">Reset Arrow Settings</button>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">Export</div>
        <div class="color-picker">
            <label for="background-color">Background Color:</label>
            <input type="color" id="background-color" value="#2a2a2a" onchange="changeBackgroundColor()">
        </div>
        <div class="checkbox-control">
            <input type="checkbox" id="transparent-background">
            <label for="transparent-background">Transparent Background</label>
        </div>
        <button onclick="downloadImage()">Download Image</button>
    </div>
    <div class="divisor"></div>
    <div class="control-section">
        <div class="section-title">State Management</div>
        <button id="reset-button-color" onclick="resetToDefault()">Reset to Default</button>
    </div>
</div>

<script>
    const defaultColors = {
        base: "#E3F9F9",
        highlight1: "#1AD1B2",
        highlight2: "#EA6C6C",
        highlight3: "#2175C4",
        backgroundColor: "#2a2a2a"
    };

    const defaultArrowColor = "#ffffff";

    const defaultFontSizes = {
        element: 30,
        index: 17
    };

    const defaultFontColors = {
        element: "#1a1a1a",
        index: "#e0e0e0"
    };

    const ELEMENT_MARGIN = 2;
    const INDEX_HEIGHT = 35;
    const ARRAY_VERTICAL_MARGIN = 20;
    const margin = {top: 30, right: 20, bottom: 30, left: 20};

    let arrayStates = [{
        elements: [1, 2, 3, 4, 5],
        highlights: new Map() // Map of index to highlight type (1, 2, or 3)
    }];

    const svg = d3.select("svg");
    const ELEMENT_HEIGHT = 80;
    let elementWidth = 80;
    let colors = {...defaultColors};
    let fontColors = {...defaultFontColors};
    let arrayNames = ["Array 1"];
    let currentArrayIndex, currentElementIndex;
    let showArrows = false;
    let arrowLabels = [];
    let arrowColor = defaultArrowColor;

    function updateSVGSize() {
        const showIndexes = document.getElementById("show-indexes").checked;
        const showNames = document.getElementById("show-names").checked;
        const showArrows = document.getElementById("show-arrows").checked;
        const numArrays = arrayStates.length;
        const maxArrayLength = Math.max(...arrayStates.map(state => state.elements.length));
        // Update element width based on the maximum element size
        elementWidth = Math.max(...arrayStates.map(state => {
            return Math.max(...state.elements.map(value =>
                calculateElementWidth(value, document.getElementById("element-font-size").value)));
        }));
        const totalWidth = maxArrayLength * (elementWidth + ELEMENT_MARGIN) - ELEMENT_MARGIN + margin.left + margin.right;

        let totalHeight = margin.top + margin.bottom;
        totalHeight += numArrays * ELEMENT_HEIGHT + (numArrays - 1) * ARRAY_VERTICAL_MARGIN;
        if (showNames) totalHeight += (numArrays * 20) - 10;
        if (showIndexes) totalHeight += numArrays * 25;
        if (showArrows && numArrays > 1) totalHeight += (numArrays - 1) * 40;

        d3.select("#array-container")
            .style("width", `${totalWidth}px`);

        svg.attr("width", totalWidth)
            .attr("height", totalHeight);

        return {totalWidth, totalHeight};
    }

    function drawArrays() {
        svg.selectAll("*").remove();

        const {totalWidth} = updateSVGSize();
        const showIndexes = document.getElementById("show-indexes").checked;
        const showNames = document.getElementById("show-names").checked;
        const showArrows = document.getElementById("show-arrows").checked;

        let cumulativeHeight = margin.top;
        let maxArrayLength = Math.max(...arrayStates.map(state => state.elements.length));

        arrayStates.forEach((state, arrayIndex) => {
            const arrayWidth = calculateArrayWidth(state.elements.length);
            const startX = (totalWidth - arrayWidth) / 2;

            if (showNames) {
                if (arrayIndex > 0) cumulativeHeight += 10;
                svg.append("text")
                    .attr("class", "array-name")
                    .attr("x", startX)
                    .attr("y", cumulativeHeight)
                    .text(arrayNames[arrayIndex] || `Array ${arrayIndex + 1}`)
                    .attr("fill", fontColors.index)
                    .style("font-family", "monospace")
                    .style("font-size", "14px")
                    .style("shape-rendering", "crispEdges");
                cumulativeHeight += 10;
            }

            // Draw array elements
            const arrayGroup = svg.append("g")
                .attr("transform", `translate(${startX}, ${cumulativeHeight})`);

            const elements = arrayGroup.selectAll("g")
                .data(state.elements.map((value, index) => ({
                    value,
                    index
                })), d => d.index) // Use index as the key for data binding
                .enter()
                .append("g")
                .attr("transform", (d, i) => `translate(${i * (elementWidth + ELEMENT_MARGIN)}, 0)`);

            elements.append("rect")
                .attr("class", "array-element")
                .attr("width", elementWidth)
                .attr("height", ELEMENT_HEIGHT)
                .attr("fill", d => {
                    const highlightType = state.highlights.get(d.index);
                    if (highlightType === 1) return colors.highlight1;
                    if (highlightType === 2) return colors.highlight2;
                    if (highlightType === 3) return colors.highlight3;
                    return colors.base;
                })
                .on("click", function (event, d) {
                    event.stopPropagation(); // Stop the event from bubbling up
                    const rect = event.target.getBoundingClientRect();
                    showElementMenu(event, arrayIndex, d.index, rect);
                });

            elements.append("text")
                .attr("class", "array-text")
                .attr("x", elementWidth / 2)
                .attr("y", ELEMENT_HEIGHT / 2 + 4)
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .text(d => String(d.value))  // Convert all values to strings for display
                .attr("fill", fontColors.element)
                .style("font-family", "Arial, sans-serif")
                .style("shape-rendering", "crispEdges");

            cumulativeHeight += ELEMENT_HEIGHT;

            if (showIndexes) {
                elements.append("text")
                    .attr("class", "index-text")
                    .attr("x", elementWidth / 2)
                    .attr("y", ELEMENT_HEIGHT + INDEX_HEIGHT / 2)
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "middle")
                    .text(d => d.index)
                    .attr("fill", fontColors.index)
                    .style("font-family", "Arial, sans-serif")
                    .style("shape-rendering", "crispEdges");
                cumulativeHeight += 25;
            }

            if (showArrows && arrayIndex < arrayStates.length - 1) {
                cumulativeHeight += 10;
                const startY = cumulativeHeight;
                const endY = cumulativeHeight + 30;
                const arrowWidth = Math.max(maxArrayLength * (elementWidth + ELEMENT_MARGIN) - ELEMENT_MARGIN, 100);

                drawArrow(margin.left + arrowWidth / 2, startY, margin.left + arrowWidth / 2, endY, arrayIndex);

                cumulativeHeight += 30;
            }

            if (arrayIndex < arrayStates.length - 1) {
                cumulativeHeight += ARRAY_VERTICAL_MARGIN;
            }
        });

        changeFontSize();
    }

    function calculateArrayWidth(arrayLength) {
        return arrayLength * (elementWidth + ELEMENT_MARGIN) - ELEMENT_MARGIN;
    }

    function getTextWidth(text, font) {
        const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
        const context = canvas.getContext("2d");
        context.font = font;
        const metrics = context.measureText(text);
        return metrics.width;
    }

    function calculateElementWidth(value, fontSize) {
        const padding = 10; // Padding on each side
        const textWidth = getTextWidth(String(value), `${fontSize}px Arial`);
        return Math.max(80, textWidth + 2 * padding);
    }

    function drawArrow(startX, startY, endX, endY, fromIndex) {
        const arrowGroup = svg.append("g").attr("class", "arrow-group");

        // Draw the visible arrow
        arrowGroup.append("path")
            .attr("d", `M${startX},${startY} L${endX},${endY}`)
            .attr("stroke", arrowColor)
            .attr("stroke-width", 3)
            .attr("marker-end", "url(#arrowhead)");

        if (!svg.select("#arrowhead").node()) {
            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 5)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", arrowColor);
        }

        // Draw a wider, transparent path for easier clicking
        arrowGroup.append("path")
            .attr("d", `M${startX},${startY} L${endX},${endY}`)
            .attr("stroke", "transparent")
            .attr("stroke-width", 20)
            .style("cursor", "pointer")
            .on("click", (event) => showArrowMenu(event, fromIndex));

        if (arrowLabels[fromIndex]) {
            arrowGroup.append("text")
                .attr("x", (startX + endX) / 2 + 20)
                .attr("y", (startY + endY) / 2 + 10)
                .attr("text-anchor", "left")
                .attr("fill", arrowColor)
                .text(arrowLabels[fromIndex]);
        }
    }

    function updateArrowLabel() {
        const menu = document.getElementById('arrow-menu');
        const arrowIndex = parseInt(menu.dataset.arrowIndex);
        arrowLabels[arrowIndex] = document.getElementById('arrow-label-input').value;
        drawArrays();
        saveState();
        hideArrowMenu();
    }

    // Load state from local storage or use default values
    function loadState() {
        const savedState = localStorage.getItem('arrayVisualizerState');
        if (savedState) {
            const state = JSON.parse(savedState);
            arrayStates = state.arrayStates.map(arr => ({
                elements: arr.elements,
                highlights: new Map(arr.highlights || [])
            }));
            arrayNames = state.arrayNames;
            colors = state.colors;
            fontColors = state.fontColors;
            elementWidth = state.elementWidth || elementWidth;
            document.getElementById("base-color").value = colors.base;
            document.getElementById("highlight1-color").value = colors.highlight1;
            document.getElementById("highlight2-color").value = colors.highlight2;
            document.getElementById("highlight3-color").value = colors.highlight3;
            document.getElementById("background-color").value = colors.backgroundColor;
            document.getElementById("array-container").style.backgroundColor = colors.backgroundColor;
            document.getElementById("element-font-color").value = fontColors.element;
            document.getElementById("index-font-color").value = fontColors.index;
            document.getElementById("element-font-size").value = state.fontSizes.element;
            document.getElementById("index-font-size").value = state.fontSizes.index;
            document.getElementById("show-indexes").checked = state.showIndexes;
            document.getElementById("show-names").checked = state.showNames;
            document.getElementById("show-arrows").checked = state.showArrows;
            document.getElementById("arrow-color").value = state.arrowColor;
            arrowColor = state.arrowColor || defaultArrowColor;
            arrowLabels = state.arrowLabels || [];
        }
    }

    // Save current state to local storage
    function saveState() {
        const state = {
            arrayStates: arrayStates.map(arr => ({
                elements: arr.elements,
                highlights: Array.from(arr.highlights.entries())
            })),
            arrayNames,
            colors,
            fontColors,
            elementWidth,
            fontSizes: {
                element: document.getElementById("element-font-size").value,
                index: document.getElementById("index-font-size").value
            },
            showIndexes: document.getElementById("show-indexes").checked,
            showNames: document.getElementById("show-names").checked,
            showArrows: document.getElementById("show-arrows").checked,
            arrowLabels: arrowLabels,
            arrowColor: arrowColor
        };
        localStorage.setItem('arrayVisualizerState', JSON.stringify(state));
    }

    // Reset to default state
    function resetToDefault() {
        arrayStates = [{
            elements: [1, 2, 3, 4, 5],
            highlights: new Map()
        }];
        arrayNames = ["Array 1"];
        colors = {...defaultColors};
        fontColors = {...defaultFontColors};
        elementWidth = 80;
        document.getElementById("base-color").value = defaultColors.base;
        document.getElementById("highlight1-color").value = defaultColors.highlight1;
        document.getElementById("highlight2-color").value = defaultColors.highlight2;
        document.getElementById("highlight3-color").value = defaultColors.highlight3;
        document.getElementById("background-color").value = defaultColors.backgroundColor;
        document.getElementById("array-container").style.backgroundColor = defaultColors.backgroundColor;
        document.getElementById("element-font-color").value = defaultFontColors.element;
        document.getElementById("index-font-color").value = defaultFontColors.index;
        document.getElementById("element-font-size").value = defaultFontSizes.element;
        document.getElementById("index-font-size").value = defaultFontSizes.index;
        document.getElementById("show-indexes").checked = true;
        document.getElementById("show-names").checked = true;
        document.getElementById("show-arrows").checked = false;
        document.getElementById("arrow-color").value = defaultArrowColor;
        arrowColor = defaultArrowColor;
        arrowLabels = [];
        updateArrayList();
        drawArrays();
    }

    function parseArrayInput(input) {
        return input.split(',').map(item => {
            item = item.trim();
            if (item === 'true') return true;
            if (item === 'false') return false;
            if (item === '') return item;  // Allow empty strings
            if (!isNaN(item)) return Number(item);
            return item;  // If it's not a number, boolean, or empty, treat it as a string
        });
    }

    function addArray() {
        const input = document.getElementById("array-input").value;
        const newArray = parseArrayInput(input);
        arrayStates.push({
            elements: newArray,
            highlights: new Map()
        });
        arrayNames.push(`Array ${arrayStates.length}`);  // Add a default name
        updateArrayList();
        drawArrays();
        document.getElementById("array-input").value = "";
    }

    function updateArrayList() {
        const arrayList = document.getElementById("array-list");
        arrayList.innerHTML = "";
        arrayStates.forEach((state, index) => {
            const arrayItem = document.createElement("div");
            arrayItem.className = "array-item";
            arrayItem.innerHTML = `
            <div class="checkbox-control">
                <input type="checkbox" id="array-${index}" checked>
                <input type="text" class="array-name-input" value="${arrayNames[index]}" onchange="updateArrayName(${index}, this.value)">
            </div>
            <div class="array-edit">
                <input type="text" id="edit-array-${index}" placeholder="Edit array (comma-separated)"
                value="${state.elements.map(String).join(", ")}" onchange="editArray(${index})">
                <button onclick="duplicateArray(${index})">Duplicate</button>
                <button id="remove-button-color" onclick="removeArray(${index})">Remove</button>
            </div>
        `;
            arrayList.appendChild(arrayItem);
        });
    }

    function updateArrayName(index, newName) {
        arrayNames[index] = newName;
        drawArrays();
    }

    function editArray(index) {
        const newArrayString = document.getElementById(`edit-array-${index}`).value;
        const newArray = parseArrayInput(newArrayString);

        arrayStates[index] = {
            elements: newArray,
            highlights: new Map()
        };

        updateArrayList();
        drawArrays();
    }

    function duplicateArray(index) {
        const newArray = arrayStates[index];
        arrayStates.push({
            elements: [...newArray.elements],
            highlights: new Map(newArray.highlights)
        });
        arrayNames.push(`${arrayNames[index]} (Copy)`);
        updateArrayList();
        drawArrays();
    }

    function removeArray(index) {
        if (arrayStates.length > 1) {
            arrayStates.splice(index, 1);
            arrayNames.splice(index, 1);
            updateArrayList();
            drawArrays();
        } else {
            alert("Cannot remove the last array. At least one array must remain.");
        }
        saveState();
    }

    function showArrowMenu(event, arrowIndex) {
        const menu = document.getElementById('arrow-menu');
        menu.style.display = 'block';
        menu.style.left = `${event.pageX}px`;
        menu.style.top = `${event.pageY}px`;

        document.getElementById('arrow-label-input').value = arrowLabels[arrowIndex] || '';
        document.getElementById('arrow-label-input').onchange = () => updateArrowLabel(arrowIndex);

        // Store the current arrow index
        menu.dataset.arrowIndex = arrowIndex;
    }

    function showElementMenu(event, arrayIndex, elementIndex, rect) {
        const menu = document.getElementById('element-menu');
        menu.style.display = 'block';

        // Get the menu's width after it's displayed
        const menuWidth = menu.offsetWidth;

        // Calculate the left position to center the menu
        const leftPosition = rect.left + (rect.width - menuWidth) / 2;

        // Ensure the menu doesn't go off-screen to the left
        const adjustedLeftPosition = Math.max(0, leftPosition);

        menu.style.left = `${adjustedLeftPosition}px`;
        menu.style.top = `${rect.bottom + 5}px`; // 5px gap between element and menu

        currentArrayIndex = arrayIndex;
        currentElementIndex = elementIndex;
        document.getElementById('edit-element-input').value = arrayStates[arrayIndex].elements[elementIndex];

        // Update highlight button colors
        document.getElementById('highlight1-button').style.backgroundColor = colors.highlight1;
        document.getElementById('highlight2-button').style.backgroundColor = colors.highlight2;
        document.getElementById('highlight3-button').style.backgroundColor = colors.highlight3;

        adjustMenuPosition(menu);
    }

    function adjustMenuPosition(menu) {
        const rect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;

        if (rect.right > viewportWidth) {
            menu.style.left = `${viewportWidth - rect.width}px`;
        }
        if (rect.bottom > viewportHeight) {
            menu.style.top = `${parseInt(menu.style.top) - rect.height - ELEMENT_HEIGHT}px`;
        }
    }

    function hideElementMenu() {
        document.getElementById('element-menu').style.display = 'none';
    }

    function hideArrowMenu() {
        document.getElementById('arrow-menu').style.display = 'none';
    }

    function updateElement() {
        arrayStates[currentArrayIndex].elements[currentElementIndex] = document.getElementById('edit-element-input').value;
        hideElementMenu();
        updateArrayList();
        drawArrays();
        saveState();
    }

    function setHighlight(type) {
        arrayStates[currentArrayIndex].highlights.set(currentElementIndex, type);
        hideElementMenu();
        drawArrays();
        saveState();
    }

    function removeHighlight() {
        arrayStates[currentArrayIndex].highlights.delete(currentElementIndex);
        hideElementMenu();
        drawArrays();
        saveState();
    }

    function updateColors() {
        colors.base = document.getElementById("base-color").value;
        colors.highlight1 = document.getElementById("highlight1-color").value;
        colors.highlight2 = document.getElementById("highlight2-color").value;
        colors.highlight3 = document.getElementById("highlight3-color").value;
        arrowColor = document.getElementById("arrow-color").value;
        svg.select("#arrowhead path").attr("fill", arrowColor);
        drawArrays();
    }

    function updateFontColors() {
        fontColors.element = document.getElementById("element-font-color").value;
        fontColors.index = document.getElementById("index-font-color").value;
        svg.selectAll(".array-text")
            .attr("fill", fontColors.element);
        svg.selectAll(".index-text, .array-name")  // Apply to both index and array name
            .attr("fill", fontColors.index);
        saveState();
    }

    function changeFontSize() {
        const elementFontSize = document.getElementById("element-font-size").value;
        const indexFontSize = document.getElementById("index-font-size").value;
        svg.selectAll(".array-text")
            .style("font-size", `${elementFontSize}px`);
        svg.selectAll(".index-text")
            .style("font-size", `${indexFontSize}px`);
        saveState();
    }

    function resetFontSettings() {
        document.getElementById("element-font-size").value = defaultFontSizes.element;
        document.getElementById("index-font-size").value = defaultFontSizes.index;
        document.getElementById("element-font-color").value = defaultFontColors.element;
        document.getElementById("index-font-color").value = defaultFontColors.index;
        changeFontSize();
        updateFontColors();
    }

    function resetArraySettings() {
        document.getElementById("base-color").value = defaultColors.base;
        document.getElementById("highlight1-color").value = defaultColors.highlight1;
        document.getElementById("highlight2-color").value = defaultColors.highlight2;
        document.getElementById("highlight3-color").value = defaultColors.highlight3;
        document.getElementById("background-color").value = defaultColors.backgroundColor;
    }

    function resetArrowSettings() {
        document.getElementById("arrow-color").value = defaultArrowColor;
        arrowColor = defaultArrowColor;
        updateColors();
        drawArrays();
        saveState();
    }

    function changeBackgroundColor() {
        document.getElementById("array-container").style.backgroundColor = document.getElementById("background-color").value;
        colors.backgroundColor = document.getElementById("background-color").value;
        saveState();
    }

    function downloadImage() {
        const svgNode = svg.node();
        const svgWidth = svgNode.width.baseVal.value;
        const svgHeight = svgNode.height.baseVal.value;

        // Increase resolution
        const scale = 2;
        const canvas = document.createElement("canvas");
        canvas.width = svgWidth * scale;
        canvas.height = svgHeight * scale;
        const ctx = canvas.getContext("2d");

        // Enable smooth scaling
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // Scale the context to increase resolution
        ctx.scale(scale, scale);

        const transparentBackground = document.getElementById("transparent-background").checked;
        if (!transparentBackground) {
            ctx.fillStyle = document.getElementById("background-color").value;
            ctx.fillRect(0, 0, svgWidth, svgHeight);
        }

        // Convert SVG to data URL
        const svgData = new XMLSerializer().serializeToString(svgNode);
        const svgBlob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = function () {
            ctx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);

            // Apply font smoothing
            ctx.textRendering = "optimizeLegibility";
            ctx.webkitFontSmoothing = "antialiased";
            ctx.mozOSXFontSmoothing = "grayscale";

            const pngUrl = canvas.toDataURL("image/png");
            const downloadLink = document.createElement("a");
            downloadLink.href = pngUrl;
            downloadLink.download = "multi_array_visualization.png";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        };
        img.src = url;
    }

    // Update the event listener for the "Show Indexes" checkbox
    document.getElementById("show-indexes").addEventListener("change", drawArrays);

    // Add an event listener to hide the menu when clicking outside
    document.addEventListener('click', function (event) {
        const menu = document.getElementById('element-menu');
        if (!menu.contains(event.target) && !event.target.classList.contains('array-element')) {
            hideElementMenu();
        }
    });

    // Add an event listener for the show-arrows checkbox
    document.getElementById("show-arrows").addEventListener("change", function () {
        showArrows = this.checked;
        drawArrays();
        saveState();
    });

    // Load state when the page loads
    window.onload = function () {
        loadState();
        updateArrayList();
        drawArrays();
    };
</script>
<div id="element-menu">
    <label for="edit-element-input"></label><input type="text" id="edit-element-input" placeholder="Edit element">
    <button onclick="updateElement()">Update</button>

    <div class="highlight-buttons">
        <button id="highlight1-button" class="highlight-button" onclick="setHighlight(1)">H1</button>
        <button id="highlight2-button" class="highlight-button" onclick="setHighlight(2)">H2</button>
        <button id="highlight3-button" class="highlight-button" onclick="setHighlight(3)">H3</button>
    </div>
    <button id="remove-button-color" onclick="removeHighlight()">Remove Highlight</button>
</div>
<div id="arrow-menu"
     style="display: none; position: absolute; background-color: #444; border: 1px solid #666; border-radius: 4px; padding: 10px;">
    <label for="arrow-label-input"></label><input type="text" id="arrow-label-input" placeholder="Enter arrow label">
    <button onclick="updateArrowLabel()">Update</button>
</div>
</body>
</html>